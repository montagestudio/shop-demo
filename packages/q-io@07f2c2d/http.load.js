montageDefine("07f2c2d","http",{dependencies:["http","https","url2","q","./reader"],factory:function(e,t){var n=e("http"),r=e("https"),i=e("url2"),o=e("q"),a=e("./reader");t.Server=function(e){var r=Object.create(t.Server.prototype),i=n.createServer(function(n,r){var i=t.ServerRequest(n),a=t.ServerResponse(r),s=o.defer();n.on("end",function(e,t){e?s.reject(e):s.resolve(t)}),o.when(i,function(t){return o.when(e(t,a),function(e){return e?(r.writeHead(e.status,e.headers),(e.onclose||e.onClose)&&o.when(s,e.onclose||e.onClose),o.when(e.body,function(t){var n;if(Array.isArray(t)&&(n=t.length)&&t.every(function(e){return"string"==typeof e}))t.forEach(function(t,i){n-1>i?r.write(t,e.charset):r.end(t,e.charset)});else{if(t){var i,a=t.forEach(function(t){i=o.when(i,function(){return o.when(t,function(t){r.write(t,e.charset)})})});return o.when(a,function(){return o.when(i,function(){r.end()})})}r.end()}})):void 0})}).done()}),a=o.defer();i.on("close",function(e){e?a.reject(e):a.resolve()}),r.stop=function(){return i.close(),s=void 0,a.promise};var s=o.defer();return i.on("listening",function(e){e?s.reject(e):s.resolve(r)}),r.listen=function(){return i.port!==void 0?o.reject(Error("A server cannot be restarted or started on a new port")):(i.listen.apply(i,arguments),s.promise)},r.stopped=a.promise,r.node=i,r.nodeServer=i,r.address=i.address.bind(i),r},Object.defineProperties(t.Server,{port:{get:function(){return this.node.port}},host:{get:function(){return this.node.host}}}),t.ServerRequest=function(e,t){var n=Object.create(e,s);n.version=e.httpVersion.split(".").map(Math.floor),n.method=e.method,n.path=e.url,n._pathInfo=null,n.scriptName="",n.scheme="http";var r=e.connection.address();n.hostname=e.headers.host?e.headers.host.split(":")[0]:r.address,n.port=r.port;var l=n.port===(t?443:80);n.host=n.hostname+(l?"":":"+n.port);var u=e.socket;return n.remoteHost=u.remoteAddress,n.remotePort=u.remotePort,n.url=i.format({protocol:n.scheme,host:e.headers.host,port:n.port===(t?443:80)?null:n.port,path:n.path}),n.body=a(e),n.headers=e.headers,n.node=e,n.nodeRequest=e,n.nodeConnection=e.connection,o.when(n.body,function(e){return n.body=e,n})};var s={pathInfo:{get:function(){return null===this._pathInfo&&(this._pathInfo=decodeURIComponent(i.parse(this.url).pathname)),this._pathInfo},set:function(e){this._pathInfo=e}}};t.ServerResponse=function(e,t){var n=Object.create(e);return n.ssl=t,n.node=e,n.nodeResponse=e,n},t.normalizeRequest=function(e){if("string"==typeof e&&(e={url:e}),e.method=e.method||"GET",e.headers=e.headers||{},e.url){var t=i.parse(e.url);e.ssl="https:"===t.protocol,e.hostname=t.hostname,e.host=t.host,e.port=+t.port,e.path=(t.pathname||"")+(t.search||""),e.auth=t.auth||void 0}if(e.host=e.host||e.headers.host,e.port=e.port||(e.ssl?443:80),e.host&&!e.hostname&&(e.hostname=e.host.split(":")[0]),e.hostname&&e.port&&!e.host){var n=e.ssl?443:80;e.host=e.hostname+(n?"":":"+e.port)}return e.headers.host=e.headers.host||e.host,e.path=e.path||"/",e},t.normalizeResponse=function(e){return void 0!==e?("string"==typeof e&&(e=[e]),e.forEach&&(e={status:200,headers:{},body:e}),e):void 0},t.request=function(e){return o.when(e,function(e){e=t.normalizeRequest(e);var i=o.defer(),a=e.ssl?r:n,s={hostname:e.hostname,port:e.port||(e.ssl?443:80),localAddress:e.localAddress,socketPath:e.socketPath,method:e.method,path:e.path,headers:e.headers,auth:e.auth};void 0!==e.agent&&(s.agent=e.agent);var l=a.request(s,function(n){i.resolve(t.ClientResponse(n,e.charset)),n.on("error",function(e){console.warn(e&&e.stack||e),i.reject(e)})});return l.on("error",function(e){i.reject(e)}),o.when(e.body,function(t){var n,r;return t&&(r=t.forEach(function(t){n=o.when(n,function(){return o.when(t,function(t){l.write(t,e.charset)})})})),o.when(n,function(){return o.when(r,function(){l.end()})})}).done(),i.promise})},t.read=function(e,n){return n=n||function(e){return 200===e.status},o.when(t.request(e),function(e){if(!n(e)){var t=Error("HTTP request failed with code "+e.status);throw t.response=e,t}return o.post(e.body,"read",[])})},t.ClientResponse=function(e,n){var r=Object.create(t.ClientResponse.prototype);return r.status=e.statusCode,r.version=e.httpVersion,r.headers=e.headers,r.node=e,r.nodeResponse=e,r.nodeConnection=e.connection,o.when(a(e,n),function(e){return r.body=e,r})}}});