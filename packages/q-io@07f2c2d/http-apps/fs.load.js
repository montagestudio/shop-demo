montageDefine("07f2c2d","http-apps/fs",{dependencies:["q","url2","mime","../fs","./status","./redirect","./negotiate","./html","../deprecate"],factory:function(e,t){var n=e("q"),r=e("url2"),i=e("mime"),o=e("../fs"),a=e("./status"),s=e("./redirect"),l=e("./negotiate"),u=e("./html"),c=e("../deprecate");t.File=function(e,n){return function(r){return t.file(r,e+"",n)}},t.FileTree=function(e,i){i||(i={}),i.notFound=i.notFound||a.notFound,i.file=i.file||t.file,i.directory=i.directory||t.directory,i.fs=i.fs||o;var l=i.fs;return e=l.canonical(e),function(t,o){r.parse(t.url),t.fs=l;var a=i.redirect||(t.permanent||i.permanent?s.permanentRedirect:s.temporaryRedirect);return n.when(e,function(e){var r=l.join(e,t.pathInfo.slice(1));return n.when(l.canonical(r),function(s){return i.followInsecureSymlinks&&(c.deprecationWarning("followInsecureSymlinks","followInsecureSymbolicLinks"),i.followInsecureSymbolicLinks=!0),l.contains(e,s)||i.followInsecureSymbolicLinks?r!==s&&i.redirectSymbolicLinks?a(t,l.relativeFromFile(r,s)):n.when(l.stat(s),function(e){return e.isFile()?i.file(t,s,i.contentType,l):e.isDirectory()?i.directory(t,s,i.contentType,l):i.notFound(t,o)}):i.notFound(t,o)},function(){return i.notFound(t,o)})})}},t.file=function(e,r,s,l){return l=l||o,s=s||i.lookup(r),n.when(l.stat(r),function(n){var i,o=t.etag(n),u={flags:"rb"},c=200,h={"content-type":s,etag:o};if("range"in e.headers)if("if-range"in e.headers&&o!=e.headers["if-range"]);else{if(i=f(e.headers.range,n.size),!i)return a.responseForStatus(e,416);if(i.end>n.size&&(i.end=n.size),i.end<=i.begin)return a.responseForStatus(e,416);c=206,h["content-range"]="bytes "+i.begin+"-"+(i.end-1)+"/"+n.size,h["content-length"]=""+(i.end-i.begin),u.begin=i.begin,u.end=i.end}else{if(o==e.headers["if-none-match"])return a.responseForStatus(e,304);h["content-length"]=""+n.size}return{status:c,headers:h,body:l.open(r,u),file:r,range:i}})};var h=/^\s*bytes\s*=\s*(\d*\s*-\s*\d*\s*(?:,\s*\d*\s*-\s*\d*\s*)*)$/,d=/^\s*(\d*)\s*-\s*(\d*)\s*$/,p=function(e,t){var n=d.exec(e);if(n&&(""!=n[1]||""!=n[2])){var r,i;return""==n[1]?(r=0,i=+n[2]+1):""==n[2]?(r=+n[1],i=t):(r=+n[1],i=+n[2]+1),{begin:r,end:i}}},f=t.interpretFirstRange=function(e,t){var n=h.exec(e);if(n){for(var r=n[1].split(/\s*,\s*/),i=p(r[0],t),o=0,a=r.length;a>o;o++){var s=p(r[o],t);if(!(s.begin<=i.end))return;i.end=s.end}return i}};t.etag=function(e){return[e.node.ino,e.size,e.lastModified().getTime()].join("-")},t.directory=function(e,t){var n=a.notFound(e);return n.directory=t,n},t.ListDirectories=function(e,r){return r=r||t.listDirectory,function(t){if(t.directoryIndex)throw Error("DirectoryIndex must be used after ListDirectories");return t.listDirectories=!0,n.fcall(e,t).then(function(e){return void 0!==e.directory?r(t,e):e})}},t.listDirectory=function(e,n){if(e.location=r.parse(e.path),e.location.file)return s.redirect(e,e.location.file+"/");var i={};i["text/plain"]=t.listDirectoryText,i["text/markdown"]=t.listDirectoryMarkdown,e.handleHtmlFragmentResponse&&(i["text/html"]=t.listDirectoryHtmlFragment),e.handleJsonResponse&&(i["application/json"]=t.listDirectoryJson);var o=l.negotiate(e,i)||function(){return n};return o(e,n)},t.listDirectoryHtmlFragment=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/html"},htmlTitle:"Directory Index",htmlFragment:{forEach:function(t){t('<ul class="directory-index">\n'),Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t('    <li class="entry '+r.type+'"><a href="'+u.escapeHtml(n+i)+'">'+u.escapeHtml(n+i)+"</a></li>\n")}),t("</ul>\n")}}}})},t.listDirectoryText=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){Object.keys(e).sort().forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t(n+i+"\n")})}}}})},t.listDirectoryMarkdown=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){t("\n# Directory Index\n\n"),Object.keys(e).forEach(function(n){var r=e[n],i="";"directory"===r.type&&(i="/"),t("-   "+n+i+"\n")}),t("\n")}}}})},t.listDirectoryJson=function(e,n){return t.listDirectoryData(e,n).then(function(e){return{status:200,headers:{},data:e}})},t.listDirectoryData=function(e,t){if(!e.fs)throw Error("Can't list a directory without a designated file system");var r=e.fs;return n.invoke(r,"list",t.directory).then(function(e){return e.sort(),e.map(function(e){return n.invoke(r,"stat",r.join(t.directory,e)).then(function(t){return t.isDirectory()?{name:e,stat:{type:"directory"}}:t.isFile()?{name:e,stat:{type:"file"}}:void 0},function(){})})}).all().then(function(e){var t={};return e.forEach(function(e){e&&(t[e.name]=e.stat)}),t})},t.DirectoryIndex=function(e,t){return t=t||"index.html",function(i){return i.directoryIndex=!0,i.location=r.parse(i.path),i.location.file===t?s.redirect(i,"."):n.fcall(e,i).then(function(o){if(void 0!==o.directory){if(i.location.file)return s.redirect(i,i.location.file+"/");var a=i.fs.join(o.directory,t);return n.invoke(i.fs,"isFile",a).then(function(n){return n?(i.url=r.resolve(i.url,t),i.pathInfo+=t,e(i)):o})}return o})}}}});