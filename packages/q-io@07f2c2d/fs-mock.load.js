montageDefine("07f2c2d","fs-mock",{dependencies:["q","./fs-boot","./fs-common","./buffer-stream","./reader","collections/set","./fs"],factory:function(e,t,n){function r(e,t){return this instanceof r?(this._root=new s(this,"/"),h.update(this,function(){return t}),t=t||this.ROOT,e&&this._init(e),void 0):new r(e,t)}function i(e,t){return u.when(e.listTree(t),function(n){var i={};return u.all(n.map(function(n){var r=e.join(t,n),o=e.relativeFromDirectory(t,r);return u.when(e.stat(r),function(t){return t.isFile()?u.when(e.read(n,"rb"),function(e){i[o]=e}):void 0})})).then(function(){return r(i)})})}function o(e){if(!e)throw Error("FS required argument");this._fs=e,this.atime=this.mtime=Date.now(),this.mode=parseInt("0644",8),this._owner=null}function a(e){o.call(this,e),this._chunks=[]}function s(e){o.call(this,e),this._entries=Object.create(null),this.mode=parseInt("0755",8)}function l(e,t){o.call(this,e),this._link=t}var u=e("q"),c=e("./fs-boot"),h=e("./fs-common"),d=e("./buffer-stream"),p=e("./reader"),f=e("collections/set");n.exports=r,r.prototype=Object.create(c),r.prototype._init=function(e,t){t=t||this.ROOT,Object.keys(e).forEach(function(n){var r=e[n];n=this.join(t,n);var i=this.directory(n),o=this.base(n),s=this._root._walk(i,!0),l=new a(this);if(!(r instanceof Buffer)){if("object"==typeof r)return this._root._walk(n,!0),this._init(r,n),void 0;r=new Buffer(r+"","utf-8")}s._entries[o]=l,l._chunks=[r]},this)},r.prototype.list=function(e){var t=this;return u.fcall(function(){e=t.absolute(e);var n=t._root._walk(e)._follow(e);return n.isDirectory()||Error("Can't list non-directory: "+JSON.stringify(e)),Object.keys(n._entries).sort()})},r.prototype.open=function(e,t,n,r){var i=this;return u.fcall(function(){e=i.absolute(e);var o=i.directory(e),s=i.base(e),l=i._root._walk(o);if(!l.isDirectory())throw Error("Can't find "+e+" because "+o+" is not a directory");"object"==typeof t?(r=t,t=r.flags,n=r.charset):r=r||{},t=t||"r";var u=t.indexOf("b")>=0,c=t.indexOf("w")>=0,h=t.indexOf("a")>=0;if(u||(n=n||"utf-8"),c||h){l._entries[s]||(l._entries[s]=new a(this),"mode"in r&&(l._entries[s].mode=r.mode));var f=l._entries[s]._follow(e);if(!f.isFile())throw Error("Can't write non-file "+e);return f.mtime=Date.now(),f.atime=Date.now(),h||(f._chunks.length=0),new d(f._chunks,n)}if(!l._entries[s])throw Error("Can't read non-existant "+e);var f=l._entries[s]._follow(e);if(!f.isFile())throw Error("Can't read non-file "+e);return f.atime=Date.now(),"begin"in r&&"end"in r?new d([p.join(f._chunks).slice(r.begin,r.end)],n):new d(f._chunks,n)})},r.prototype.remove=function(e){var t=this;return u.fcall(function(){e=t.absolute(e);var n=t.directory(e),r=t.base(e),i=t._root._walk(n);if(!i.isDirectory())throw Error("Can't remove file from non-directory: "+e);if(!i._entries[r])throw Error("Can't remove non-existant file: "+e);if(i._entries[r].isDirectory())throw Error("Can't remove directory. Use removeDirectory: "+e);delete i._entries[r]})},r.prototype.makeDirectory=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e);var r=n.directory(e),i=n.base(e),o=n._root._walk(r);if(!o.isDirectory()){var a=Error("Can't make directory in non-directory: "+e);throw a.code="EEXISTS",a.exists=!0,a}if(o._entries[i]){var a=Error("Can't make directory. Entry exists: "+e);throw a.code="EISDIR",a.exists=!0,a.isDirectory=!0,a}o._entries[i]=new s(n),t&&(o._entries[i].mode=t)})},r.prototype.removeDirectory=function(e){var t=this;return u.fcall(function(){e=t.absolute(e);var n=t.directory(e),r=t.base(e),i=t._root._walk(n);if(!i.isDirectory())throw Error("Can't remove directory from non-directory: "+e);if(!i._entries[r])throw Error("Can't remove non-existant directory: "+e);if(!i._entries[r].isDirectory())throw Error("Can't remove non-directory: "+e);delete i._entries[r]})},r.prototype.stat=function(e){var t=this;return u.fcall(function(){return e=t.absolute(e),new t.Stats(t._root._walk(e)._follow(e))})},r.prototype.statLink=function(e){var t=this;return u.fcall(function(){return e=t.absolute(e),new t.Stats(t._root._walk(e))})},r.prototype.link=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e),t=n.absolute(t);var r=n._root._walk(e)._follow(e);if(!r.isFile())throw Error("Can't link non-file: "+e);var i=n.directory(t),o=n.base(t),a=n._root._walk(i)._follow(i);if(!a.isDirectory())throw Error("Can't create link in non-directory: "+t);if(a._entries[o]&&a._entries[o].isDirectory())throw Error("Can't overwrite existing directory with hard link: "+t);a._entries[o]=r})},r.prototype.symbolicLink=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e);var r=n.directory(e),i=n.base(e),o=n._root._walk(r);if(o._entries[i]&&o._entries[i].isDirectory())throw Error("Can't overwrite existing directory with symbolic link: "+e);o._entries[i]=new l(n,t)})},r.prototype.chown=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e),n._root._walk(e)._follow(e)._owner=t})},r.prototype.chmod=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e),n._root._walk(e)._follow(e).mode=t})},r.prototype.rename=function(e,t){var n=this;return u.fcall(function(){e=n.absolute(e),t=n.absolute(t);var r=n.directory(e),i=n._root._walk(r)._follow(r),o=n.base(e),a=i._entries[o];if(!a){var s=Error("Can't copy non-existent file: "+e);throw s.code="ENOENT",s}if(a=a._follow(e),!a){var s=Error("Can't copy non-existent file: "+e);throw s.code="ENOENT",s}var l=n.directory(t),u=n._root._walk(l)._follow(l),c=n.base(t),h=u._entries[c];if(h&&(h=h._follow(t)),h&&h.isDirectory()){var s=Error("Can't copy over existing directory: "+t);throw s.code="EISDIR",s}h!==a&&(u._entries[c]=a,delete i._entries[o])})},r.prototype.readLink=function(e){var t=this;return u.fcall(function(){e=t.absolute(e);var n=t._root._walk(e);if(!t.isSymbolicLink())throw Error("Can't read non-symbolic link: "+e);return n._link})},r.prototype.canonical=function(e){var t=this;return u.fcall(function(){return e=t.absolute(e),t._root._canonical(e)})},r.mock=i,o.prototype._walk=function(e,t,n){var r=this._fs.split(e);return this._fs.isAbsolute(e)?(r.shift(),this._fs._root._walkParts(r,t,this._fs.ROOT)):this._walkParts(r,t,n||this._fs.ROOT)},o.prototype._walkParts=function(e,t,n){if(0===e.length)return this;var r=e.shift();if(""===r)return this._walkParts(e,t,this._fs.join(n,r));var i=Error("Can't find "+JSON.stringify(this._fs.resolve(r,this._fs.join(e)))+" via "+JSON.stringify(n));throw i.code="ENOENT",i},o.prototype._canonical=function(e){if(!this._fs.isAbsolute(e))throw Error("Path must be absolute for _canonical: "+e);var t=this._fs.split(e);t.shift();var n=this._fs.ROOT;return n+this._fs._root._canonicalParts(t,n)},o.prototype._canonicalParts=function(e,t){return 0===e.length?t:this._fs.join(t,this._fs.join(e))},o.prototype._follow=function(){return this},o.prototype._touch=function(){this.mtime=Date.now()};var v=["isDirectory","isFile","isBlockDevice","isCharacterDevice","isSymbolicLink","isFIFO","isSocket"];v.forEach(function(e){o.prototype[e]=function(){return!1}}),o.prototype.lastAccessed=function(){return this.atime},o.prototype.lastModified=function(){return this.mtime},a.prototype=Object.create(o.prototype),a.prototype.isFile=function(){return!0},Object.defineProperty(a.prototype,"size",{configurable:!0,enumerable:!0,get:function(){return this._chunks.reduce(function(e,t){return e+=t.length},0)}}),s.prototype=Object.create(o.prototype),s.prototype.isDirectory=function(){return!0},s.prototype._walkParts=function(e,t,n){if(n=n||this._fs.ROOT,0===e.length)return this;var r=e.shift();if(""===r)return this._walkParts(e,t,this._fs.join(n,r));if(!this._entries[r]){if(!t){var i=Error("Can't find "+JSON.stringify(this._fs.join(e))+" via "+JSON.stringify(n));throw i.code="ENOENT",i}this._entries[r]=new s(this._fs)}return this._entries[r]._walkParts(e,t,this._fs.join(n,r))},s.prototype._canonicalParts=function(e,t){if(0===e.length)return t;var n=e.shift();return""===n?t:(t===this._fs.ROOT&&(t=""),this._entries[n]?this._entries[n]._canonicalParts(e,this._fs.join(t,n)):this._fs.join(t,n,this._fs.join(e)))},l.prototype=Object.create(o.prototype),l.prototype.isSymbolicLink=function(){return!0},l.prototype._follow=function(e,t){if(t=t||f(),t.has(this)){var n=Error("Can't follow symbolic link cycle at "+JSON.stringify(e));throw n.code="ELOOP",n}t.add(this);var r=this._fs.join(e,"..",this._link);return this._walk(r,null,"<link>")._follow(r,t)},l.prototype._canonicalParts=function(e,t){return this._fs.relativeFromDirectory(this._fs.ROOT,this._fs._root._canonical(this._fs.absolute(this._fs.join(t,"..",this._link))))},e("./fs")}});